<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AgentPact</title>
<link rel="preconnect" href="https://rsms.me/">
<link rel="stylesheet" href="https://rsms.me/inter/inter.css">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg:         #09090b;
    --bg-raised:  #0f0f12;
    --bg-card:    #131316;
    --bg-hover:   #1a1a1f;
    --bg-input:   #18181b;
    --border:     rgba(255,255,255,0.06);
    --border-l:   rgba(255,255,255,0.08);
    --border-xl:  rgba(255,255,255,0.12);
    --text:       #fafafa;
    --text-2:     #a1a1aa;
    --text-3:     #71717a;
    --text-4:     #52525b;
    --accent:     #818cf8;
    --accent-bg:  rgba(129,140,248,0.08);
    --green:      #4ade80;
    --green-bg:   rgba(74,222,128,0.08);
    --red:        #f87171;
    --red-bg:     rgba(248,113,113,0.08);
    --amber:      #fbbf24;
    --amber-bg:   rgba(251,191,36,0.08);
    --r:          12px;
    --r-sm:       8px;
    --r-xs:       6px;
  }

  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.5;
    font-feature-settings: 'cv01', 'cv02', 'cv03', 'cv04';
    -webkit-font-smoothing: antialiased;
    font-size: 14px;
  }

  .wrap { max-width: 1120px; margin: 0 auto; padding: 0 28px; }

  /* ─── Nav ──────────────────────────────────────────── */
  nav {
    position: sticky; top: 0; z-index: 100;
    background: rgba(9,9,11,0.8);
    backdrop-filter: saturate(180%) blur(20px);
    -webkit-backdrop-filter: saturate(180%) blur(20px);
    border-bottom: 1px solid var(--border);
  }
  .nav-inner {
    display: flex; align-items: center; justify-content: space-between;
    height: 52px;
  }
  .brand { display: flex; align-items: center; gap: 10px; }
  .brand-mark {
    width: 26px; height: 26px; border-radius: 7px;
    background: linear-gradient(135deg, #6366f1 0%, #818cf8 50%, #a78bfa 100%);
    display: grid; place-items: center;
    font-weight: 700; font-size: 12px; color: #fff;
    box-shadow: 0 0 0 1px rgba(99,102,241,0.3), 0 1px 2px rgba(0,0,0,0.3);
  }
  .brand-name {
    font-size: 15px; font-weight: 600; letter-spacing: -0.02em; color: var(--text);
  }
  .nav-meta {
    display: flex; align-items: center; gap: 16px; font-size: 13px; color: var(--text-3);
  }
  .nav-meta .live {
    display: flex; align-items: center; gap: 6px;
  }
  .live-dot {
    width: 6px; height: 6px; border-radius: 50%; background: var(--green);
    box-shadow: 0 0 6px rgba(74,222,128,0.4);
    animation: blink 2.5s ease-in-out infinite;
  }
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }

  /* ─── Stats ────────────────────────────────────────── */
  .stats-grid {
    display: grid; grid-template-columns: repeat(4,1fr); gap: 1px;
    background: var(--border);
    border: 1px solid var(--border);
    border-radius: var(--r);
    overflow: hidden;
    margin: 28px 0 0;
  }
  .stat-cell {
    background: var(--bg-card); padding: 22px 24px;
    transition: background .15s;
  }
  .stat-cell:hover { background: var(--bg-hover); }
  .stat-num {
    font-size: 28px; font-weight: 600; letter-spacing: -0.035em;
    font-variant-numeric: tabular-nums; line-height: 1.15;
  }
  .stat-lbl { font-size: 12px; color: var(--text-3); margin-top: 2px; letter-spacing: 0.01em; }
  .c-green { color: var(--green); }
  .c-red { color: var(--red); }
  .c-amber { color: var(--amber); }

  /* ─── Section ──────────────────────────────────────── */
  .sec { margin-top: 36px; }
  .sec-head {
    display: flex; align-items: baseline; justify-content: space-between;
    margin-bottom: 14px;
  }
  .sec-title {
    font-size: 13px; font-weight: 600; color: var(--text); letter-spacing: -0.005em;
  }
  .sec-sub { font-size: 12px; color: var(--text-4); }

  /* ─── Pipeline ─────────────────────────────────────── */
  .pipeline-card {
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: var(--r); padding: 36px 28px;
    position: relative; overflow: hidden;
  }
  .pipeline-card::before {
    content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px;
    background: linear-gradient(90deg, transparent 0%, var(--accent) 50%, transparent 100%);
    opacity: 0.25;
  }
  .pl-row {
    display: flex; align-items: center; justify-content: center; gap: 0;
  }
  .pl-node {
    display: flex; flex-direction: column; align-items: center; gap: 10px;
    min-width: 120px; padding: 0 8px;
  }
  .pl-avatar {
    width: 42px; height: 42px; border-radius: 11px;
    display: grid; place-items: center;
    font-size: 13px; font-weight: 700; color: #fff;
    box-shadow: inset 0 1px 0 rgba(255,255,255,0.08), 0 2px 8px rgba(0,0,0,0.3);
  }
  .pl-avatar.n0 { background: linear-gradient(135deg, #6366f1, #818cf8); }
  .pl-avatar.n1 { background: linear-gradient(135deg, #3b82f6, #06b6d4); }
  .pl-avatar.n2 { background: linear-gradient(135deg, #f59e0b, #ef4444); }
  .pl-avatar.n3 { background: linear-gradient(135deg, #10b981, #34d399); }
  .pl-name { font-size: 12px; font-weight: 500; color: var(--text); text-align: center; }
  .pl-role {
    font-size: 10px; font-weight: 500; color: var(--text-4);
    background: var(--bg-hover); padding: 2px 7px; border-radius: 4px;
    text-transform: uppercase; letter-spacing: 0.04em;
  }
  .pl-edge {
    display: flex; flex-direction: column; align-items: center; gap: 5px;
    padding: 0 6px; min-width: 64px;
  }
  .pl-line {
    width: 44px; height: 1.5px; border-radius: 1px; position: relative;
    transition: background .3s;
  }
  .pl-line::after {
    content: ''; position: absolute; right: -2px; top: -3.5px;
    border-top: 4.5px solid transparent; border-bottom: 4.5px solid transparent;
    transition: border-color .3s;
  }
  .pl-line.idle { background: var(--border-xl); }
  .pl-line.idle::after { border-left: 6px solid var(--border-xl); }
  .pl-line.ok { background: var(--green); }
  .pl-line.ok::after { border-left: 6px solid var(--green); }
  .pl-line.err { background: var(--red); }
  .pl-line.err::after { border-left: 6px solid var(--red); }
  .pl-ctr { font-size: 10px; font-weight: 500; color: var(--text-4); font-variant-numeric: tabular-nums; }

  /* ─── Actions ──────────────────────────────────────── */
  .act-row { display: flex; gap: 8px; flex-wrap: wrap; }
  .btn {
    font-family: inherit; font-size: 13px; font-weight: 500;
    padding: 7px 14px; border-radius: var(--r-xs);
    border: 1px solid var(--border-l); background: var(--bg-card);
    color: var(--text-2); cursor: pointer;
    transition: all .12s ease; outline: none;
  }
  .btn:hover { background: var(--bg-hover); border-color: var(--border-xl); color: var(--text); }
  .btn:active { transform: scale(0.97); }
  .btn.accent {
    background: rgba(99,102,241,0.12); border-color: rgba(99,102,241,0.25);
    color: var(--accent);
  }
  .btn.accent:hover {
    background: rgba(99,102,241,0.18); border-color: rgba(99,102,241,0.35);
  }

  /* ─── Cards ────────────────────────────────────────── */
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .card {
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: var(--r); overflow: hidden;
  }
  .card-head {
    padding: 14px 18px; border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
    font-size: 12px; font-weight: 600; color: var(--text-2);
    text-transform: uppercase; letter-spacing: 0.04em;
  }
  .card-head .count { font-weight: 400; color: var(--text-4); text-transform: none; letter-spacing: 0; }

  /* ─── Violations ───────────────────────────────────── */
  .v-row {
    display: flex; align-items: center; gap: 10px;
    padding: 10px 18px; border-bottom: 1px solid var(--border);
    font-size: 13px; transition: background .1s;
  }
  .v-row:last-child { border-bottom: none; }
  .v-row:hover { background: var(--bg-hover); }
  .sev {
    font-size: 10px; font-weight: 600; padding: 2px 7px;
    border-radius: 4px; text-transform: uppercase; letter-spacing: 0.03em;
    flex-shrink: 0;
  }
  .sev.critical { background: var(--red-bg); color: var(--red); }
  .sev.high { background: var(--amber-bg); color: var(--amber); }
  .sev.medium { background: rgba(129,140,248,0.08); color: var(--accent); }
  .v-id { font-size: 12px; color: var(--text-3); min-width: 96px; font-variant-numeric: tabular-nums; }
  .v-msg { flex: 1; color: var(--text-3); font-size: 12px; }
  .v-ct { font-size: 12px; color: var(--text-4); font-variant-numeric: tabular-nums; margin-left: auto; }

  /* ─── Agent Bars ───────────────────────────────────── */
  .ab-list { padding: 14px 18px; }
  .ab-row { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
  .ab-row:last-child { margin-bottom: 0; }
  .ab-name {
    font-size: 12px; color: var(--text-3); min-width: 100px;
    text-align: right; font-variant-numeric: tabular-nums;
  }
  .ab-track { flex: 1; height: 5px; background: var(--border); border-radius: 3px; overflow: hidden; display: flex; }
  .ab-bar { height: 100%; transition: width .5s ease; }
  .ab-bar.g { background: var(--green); }
  .ab-bar.r { background: var(--red); }
  .ab-total { font-size: 11px; color: var(--text-4); min-width: 28px; font-variant-numeric: tabular-nums; }

  /* ─── Audit Trail ──────────────────────────────────── */
  .h-head {
    display: grid; grid-template-columns: 56px 1fr 80px 52px;
    gap: 10px; padding: 10px 18px; font-size: 11px;
    color: var(--text-4); text-transform: uppercase; letter-spacing: 0.04em;
    font-weight: 600; border-bottom: 1px solid var(--border);
  }
  .h-row {
    display: grid; grid-template-columns: 56px 1fr 80px 52px;
    gap: 10px; align-items: center;
    padding: 9px 18px; border-bottom: 1px solid var(--border);
    font-size: 13px; transition: background .1s;
  }
  .h-row:last-child { border-bottom: none; }
  .h-row:hover { background: var(--bg-hover); }
  .badge {
    font-size: 10px; font-weight: 600; padding: 2px 8px;
    border-radius: 4px; text-transform: uppercase; letter-spacing: 0.03em;
    text-align: center; width: fit-content;
  }
  .badge.pass { background: var(--green-bg); color: var(--green); }
  .badge.fail { background: var(--red-bg); color: var(--red); }
  .h-agents { display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--text-2); }
  .h-arrow { color: var(--text-4); }
  .h-time { font-size: 11px; color: var(--text-4); font-variant-numeric: tabular-nums; }
  .h-viol { font-size: 12px; color: var(--text-4); text-align: right; font-variant-numeric: tabular-nums; }

  /* ─── Scrollable ───────────────────────────────────── */
  .scroll { max-height: 380px; overflow-y: auto; }
  .scroll::-webkit-scrollbar { width: 5px; }
  .scroll::-webkit-scrollbar-track { background: transparent; }
  .scroll::-webkit-scrollbar-thumb { background: var(--border-xl); border-radius: 3px; }

  /* ─── Toast ────────────────────────────────────────── */
  .toast-wrap {
    position: fixed; bottom: 20px; right: 20px; z-index: 200;
    display: flex; flex-direction: column; gap: 8px; pointer-events: none;
  }
  .toast {
    pointer-events: auto;
    background: var(--bg-card); border: 1px solid var(--border-l);
    border-radius: var(--r-sm); padding: 10px 16px; font-size: 13px;
    max-width: 340px; color: var(--text-2);
    animation: tin .25s ease, tout .25s ease 2.75s forwards;
    box-shadow: 0 4px 24px rgba(0,0,0,0.4);
  }
  .toast.ok { border-left: 3px solid var(--green); }
  .toast.err { border-left: 3px solid var(--red); }
  @keyframes tin { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }
  @keyframes tout { from{opacity:1} to{opacity:0} }

  .empty { padding: 28px 18px; text-align: center; color: var(--text-4); font-size: 13px; }

  @media (max-width: 768px) {
    .grid-2 { grid-template-columns: 1fr; }
    .stats-grid { grid-template-columns: repeat(2,1fr); }
    .pl-row { flex-wrap: wrap; justify-content: center; }
  }

  .footer { height: 64px; }
</style>
</head>
<body>

<nav>
  <div class="wrap nav-inner">
    <div class="brand">
      <div class="brand-mark">A</div>
      <span class="brand-name">AgentPact</span>
    </div>
    <div class="nav-meta">
      <span class="live"><span class="live-dot"></span> Monitoring</span>
      <span id="nav-info">4 agents &middot; 3 contracts</span>
    </div>
  </div>
</nav>

<div class="wrap">

  <div class="stats-grid" id="stats">
    <div class="stat-cell">
      <div class="stat-num" id="s-total">&mdash;</div>
      <div class="stat-lbl">Total Handoffs</div>
    </div>
    <div class="stat-cell">
      <div class="stat-num c-green" id="s-pass">&mdash;</div>
      <div class="stat-lbl">Passed</div>
    </div>
    <div class="stat-cell">
      <div class="stat-num c-red" id="s-fail">&mdash;</div>
      <div class="stat-lbl">Failed</div>
    </div>
    <div class="stat-cell">
      <div class="stat-num c-amber" id="s-block">&mdash;</div>
      <div class="stat-lbl">Blocked</div>
    </div>
  </div>

  <div class="sec">
    <div class="sec-head">
      <span class="sec-title">Agent Pipeline</span>
      <span class="sec-sub">Contract-validated handoff chain</span>
    </div>
    <div class="pipeline-card">
      <div class="pl-row">
        <div class="pl-node">
          <div class="pl-avatar n0">CS</div>
          <div class="pl-name">Customer Service</div>
          <div class="pl-role">Read Only</div>
        </div>
        <div class="pl-edge">
          <div class="pl-line idle" id="e0"></div>
          <div class="pl-ctr">CTR-001</div>
        </div>
        <div class="pl-node">
          <div class="pl-avatar n1">RA</div>
          <div class="pl-name">Research</div>
          <div class="pl-role">Read Write</div>
        </div>
        <div class="pl-edge">
          <div class="pl-line idle" id="e1"></div>
          <div class="pl-ctr">CTR-002</div>
        </div>
        <div class="pl-node">
          <div class="pl-avatar n2">TA</div>
          <div class="pl-name">Trading</div>
          <div class="pl-role">Execute</div>
        </div>
        <div class="pl-edge">
          <div class="pl-line idle" id="e2"></div>
          <div class="pl-ctr">CTR-003</div>
        </div>
        <div class="pl-node">
          <div class="pl-avatar n3">CA</div>
          <div class="pl-name">Compliance</div>
          <div class="pl-role">Admin</div>
        </div>
      </div>
    </div>
  </div>

  <div class="sec">
    <div class="sec-head">
      <span class="sec-title">Simulate</span>
      <span class="sec-sub">Run validation scenarios</span>
    </div>
    <div class="act-row">
      <button class="btn accent" onclick="sim('happy')">Valid Handoff</button>
      <button class="btn" onclick="sim('ssn_leak')">SSN Leak</button>
      <button class="btn" onclick="sim('large_tx')">Large Transaction</button>
      <button class="btn" onclick="sim('authority_escalation')">Authority Escalation</button>
    </div>
  </div>

  <div class="sec">
    <div class="grid-2">
      <div class="card">
        <div class="card-head">
          <span>Top Violations</span>
          <span class="count" id="viol-ct"></span>
        </div>
        <div class="scroll" id="viol-list"><div class="empty">Loading</div></div>
      </div>
      <div class="card">
        <div class="card-head"><span>Agent Activity</span></div>
        <div class="ab-list" id="ab-list"><div class="empty">Loading</div></div>
      </div>
    </div>
  </div>

  <div class="sec">
    <div class="sec-head">
      <span class="sec-title">Audit Trail</span>
      <span class="sec-sub" id="h-ct"></span>
    </div>
    <div class="card" style="margin-bottom: 0;">
      <div class="h-head">
        <span>Status</span><span>Handoff</span><span>Time</span><span style="text-align:right">Issues</span>
      </div>
      <div class="scroll" id="h-list"><div class="empty">Loading</div></div>
    </div>
  </div>

  <div class="footer"></div>
</div>

<div class="toast-wrap" id="toasts"></div>

<script>
const F = url => fetch(url).then(r => r.json());
const $ = id => document.getElementById(id);

const NAMES = {
  customer_service: 'customer_svc',
  research_agent: 'research',
  trading_agent: 'trading',
  compliance_agent: 'compliance',
};
const sn = n => NAMES[n] || n;
const trunc = (s, n) => s.length > n ? s.slice(0, n) + '\u2026' : s;

function renderStats(d) {
  const s = d.summary;
  $('s-total').textContent = s.total_handoffs;
  $('s-pass').textContent = s.passed;
  $('s-fail').textContent = s.failed;
  $('s-block').textContent = s.blocked;
}

function renderViolations(d) {
  const el = $('viol-list');
  const items = (d.violations && d.violations.top_violations) || [];
  $('viol-ct').textContent = items.length ? items.length + ' types' : '';
  if (!items.length) { el.innerHTML = '<div class="empty">No violations</div>'; return; }
  el.innerHTML = items.map(v => {
    const rid = (v.rule || '').split(':')[0].trim();
    const rname = (v.rule || '').split(':').slice(1).join(':').trim();
    const s = rid.match(/^FIN-PII|^FIN-AUTH-00[12]|^FIN-DATA|^FIN-AUDIT-002|^CONTRACT/) ? 'critical'
      : rid.match(/^FIN-|^SCHEMA_00[13]|^AUTH_/) ? 'high' : 'medium';
    return `<div class="v-row">
      <span class="sev ${s}">${s}</span>
      <span class="v-id">${rid}</span>
      <span class="v-msg">${trunc(rname || rid, 44)}</span>
      <span class="v-ct">${v.count}&times;</span>
    </div>`;
  }).join('');
}

function renderAgents(d) {
  const el = $('ab-list');
  const agents = d.agents || {};
  const names = Object.keys(agents);
  if (!names.length) { el.innerHTML = '<div class="empty">No data</div>'; return; }
  const mx = Math.max(...names.map(n => agents[n].total || 1));
  el.innerHTML = names.map(n => {
    const a = agents[n];
    const pw = ((a.passed / mx) * 100).toFixed(1);
    const fw = ((a.failed / mx) * 100).toFixed(1);
    return `<div class="ab-row">
      <span class="ab-name">${sn(n)}</span>
      <div class="ab-track">
        <div class="ab-bar g" style="width:${pw}%"></div>
        <div class="ab-bar r" style="width:${fw}%"></div>
      </div>
      <span class="ab-total">${a.total}</span>
    </div>`;
  }).join('');
}

function renderHandoffs(list) {
  const el = $('h-list');
  $('h-ct').textContent = list.length + ' records';
  if (!list.length) { el.innerHTML = '<div class="empty">No handoffs</div>'; return; }
  el.innerHTML = [...list].reverse().map(h => {
    const r = h.result || 'pass';
    const t = h.timestamp ? new Date(h.timestamp).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'}) : '';
    return `<div class="h-row">
      <span class="badge ${r}">${r}</span>
      <div class="h-agents">
        <span>${sn(h.consumer)}</span>
        <span class="h-arrow">\u2192</span>
        <span>${sn(h.provider)}</span>
      </div>
      <span class="h-time">${t}</span>
      <span class="h-viol">${h.total_violations}</span>
    </div>`;
  }).join('');
}

function updateEdges(list) {
  const m = {'customer_service:research_agent':'e0','research_agent:trading_agent':'e1','trading_agent:compliance_agent':'e2'};
  Object.values(m).forEach(id => { const e = $(id); if(e) e.className = 'pl-line idle'; });
  for (const h of list) {
    const k = h.consumer + ':' + h.provider;
    const id = m[k]; if (!id) continue;
    const e = $(id); if (!e) continue;
    e.className = 'pl-line ' + (h.blocked ? 'err' : h.result === 'pass' ? 'ok' : 'err');
  }
}

function toast(msg, ok) {
  const t = document.createElement('div');
  t.className = 'toast ' + (ok ? 'ok' : 'err');
  t.textContent = msg;
  $('toasts').appendChild(t);
  setTimeout(() => t.remove(), 3000);
}

async function sim(scenario) {
  try {
    const d = await fetch('/api/simulate/' + scenario, {method:'POST'}).then(r=>r.json());
    if (d.error) { toast('Error: ' + d.error, false); return; }
    const lbl = {happy:'Valid handoff',ssn_leak:'SSN leak',large_tx:'Large transaction',authority_escalation:'Authority escalation'}[scenario] || scenario;
    toast(lbl + (d.result === 'pass' ? ': Passed' : ': ' + (d.blocked ? 'Blocked' : 'Failed')) + ' \u2014 ' + d.total_violations + ' violations', d.result === 'pass');
    await load();
  } catch(e) { toast('Error: ' + e.message, false); }
}

async function load() {
  const [summary, handoffs] = await Promise.all([F('/api/summary'), F('/api/handoffs')]);
  renderStats(summary);
  renderViolations(summary);
  renderAgents(summary);
  renderHandoffs(handoffs);
  updateEdges(handoffs);
}

load();
</script>
</body>
</html>
