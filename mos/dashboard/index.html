<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Failsafe</title>
<link rel="preconnect" href="https://rsms.me/">
<link rel="stylesheet" href="https://rsms.me/inter/inter.css">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg:         #09090b;
    --bg-raised:  #0f0f12;
    --bg-card:    #131316;
    --bg-hover:   #1a1a1f;
    --bg-input:   #18181b;
    --border:     rgba(255,255,255,0.06);
    --border-l:   rgba(255,255,255,0.08);
    --border-xl:  rgba(255,255,255,0.12);
    --text:       #fafafa;
    --text-2:     #a1a1aa;
    --text-3:     #71717a;
    --text-4:     #52525b;
    --accent:     #818cf8;
    --accent-bg:  rgba(129,140,248,0.08);
    --green:      #4ade80;
    --green-bg:   rgba(74,222,128,0.08);
    --red:        #f87171;
    --red-bg:     rgba(248,113,113,0.08);
    --amber:      #fbbf24;
    --amber-bg:   rgba(251,191,36,0.08);
    --r:          12px;
    --r-sm:       8px;
    --r-xs:       6px;
  }

  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.5;
    font-feature-settings: 'cv01', 'cv02', 'cv03', 'cv04';
    -webkit-font-smoothing: antialiased;
    font-size: 14px;
  }

  .wrap { max-width: 1120px; margin: 0 auto; padding: 0 28px; }

  /* ─── Nav ──────────────────────────────────────────── */
  nav {
    position: sticky; top: 0; z-index: 100;
    background: rgba(9,9,11,0.8);
    backdrop-filter: saturate(180%) blur(20px);
    -webkit-backdrop-filter: saturate(180%) blur(20px);
    border-bottom: 1px solid var(--border);
  }
  .nav-inner {
    display: flex; align-items: center; justify-content: space-between;
    height: 52px;
  }
  .brand { display: flex; align-items: center; gap: 10px; }
  .brand-mark {
    width: 26px; height: 26px; border-radius: 7px;
    background: linear-gradient(135deg, #6366f1 0%, #818cf8 50%, #a78bfa 100%);
    display: grid; place-items: center;
    font-weight: 700; font-size: 12px; color: #fff;
    box-shadow: 0 0 0 1px rgba(99,102,241,0.3), 0 1px 2px rgba(0,0,0,0.3);
  }
  .brand-name {
    font-size: 15px; font-weight: 600; letter-spacing: -0.02em; color: var(--text);
  }
  .nav-meta {
    display: flex; align-items: center; gap: 16px; font-size: 13px; color: var(--text-3);
  }
  .nav-meta .live {
    display: flex; align-items: center; gap: 6px;
  }
  .live-dot {
    width: 6px; height: 6px; border-radius: 50%; background: var(--green);
    box-shadow: 0 0 6px rgba(74,222,128,0.4);
    animation: blink 2.5s ease-in-out infinite;
  }
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }

  /* ─── Stats ────────────────────────────────────────── */
  .stats-grid {
    display: grid; grid-template-columns: repeat(4,1fr); gap: 1px;
    background: var(--border);
    border: 1px solid var(--border);
    border-radius: var(--r);
    overflow: hidden;
    margin: 28px 0 0;
  }
  .stat-cell {
    background: var(--bg-card); padding: 22px 24px;
    transition: background .15s;
  }
  .stat-cell:hover { background: var(--bg-hover); }
  .stat-num {
    font-size: 28px; font-weight: 600; letter-spacing: -0.035em;
    font-variant-numeric: tabular-nums; line-height: 1.15;
  }
  .stat-lbl { font-size: 12px; color: var(--text-3); margin-top: 2px; letter-spacing: 0.01em; }
  .c-green { color: var(--green); }
  .c-red { color: var(--red); }
  .c-amber { color: var(--amber); }

  /* ─── Section ──────────────────────────────────────── */
  .sec { margin-top: 36px; }
  .sec-head {
    display: flex; align-items: baseline; justify-content: space-between;
    margin-bottom: 14px;
  }
  .sec-title {
    font-size: 13px; font-weight: 600; color: var(--text); letter-spacing: -0.005em;
  }
  .sec-sub { font-size: 12px; color: var(--text-4); }

  /* ─── Pipeline ─────────────────────────────────────── */
  .pipeline-card {
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: var(--r); padding: 36px 28px;
    position: relative; overflow: hidden;
  }
  .pipeline-card::before {
    content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px;
    background: linear-gradient(90deg, transparent 0%, var(--accent) 50%, transparent 100%);
    opacity: 0.25;
  }
  .pl-row {
    display: flex; align-items: center; justify-content: center; gap: 0;
  }
  .pl-node {
    display: flex; flex-direction: column; align-items: center; gap: 10px;
    min-width: 120px; padding: 0 8px;
  }
  .pl-avatar {
    width: 42px; height: 42px; border-radius: 11px;
    display: grid; place-items: center;
    font-size: 13px; font-weight: 700; color: #fff;
    box-shadow: inset 0 1px 0 rgba(255,255,255,0.08), 0 2px 8px rgba(0,0,0,0.3);
  }
  .pl-avatar.n0 { background: linear-gradient(135deg, #6366f1, #818cf8); }
  .pl-avatar.n1 { background: linear-gradient(135deg, #3b82f6, #06b6d4); }
  .pl-avatar.n2 { background: linear-gradient(135deg, #f59e0b, #ef4444); }
  .pl-avatar.n3 { background: linear-gradient(135deg, #10b981, #34d399); }
  .pl-name { font-size: 12px; font-weight: 500; color: var(--text); text-align: center; }
  .pl-role {
    font-size: 10px; font-weight: 500; color: var(--text-4);
    background: var(--bg-hover); padding: 2px 7px; border-radius: 4px;
    text-transform: uppercase; letter-spacing: 0.04em;
  }
  .pl-edge {
    display: flex; flex-direction: column; align-items: center; gap: 5px;
    padding: 0 6px; min-width: 64px;
  }
  .pl-line {
    width: 44px; height: 1.5px; border-radius: 1px; position: relative;
    transition: background .3s;
  }
  .pl-line::after {
    content: ''; position: absolute; right: -2px; top: -3.5px;
    border-top: 4.5px solid transparent; border-bottom: 4.5px solid transparent;
    transition: border-color .3s;
  }
  .pl-line.idle { background: var(--border-xl); }
  .pl-line.idle::after { border-left: 6px solid var(--border-xl); }
  .pl-line.ok { background: var(--green); }
  .pl-line.ok::after { border-left: 6px solid var(--green); }
  .pl-line.err { background: var(--red); }
  .pl-line.err::after { border-left: 6px solid var(--red); }
  .pl-ctr { font-size: 10px; font-weight: 500; color: var(--text-4); font-variant-numeric: tabular-nums; }

  /* ─── Actions ──────────────────────────────────────── */
  .act-row { display: flex; gap: 8px; flex-wrap: wrap; }
  .btn {
    font-family: inherit; font-size: 13px; font-weight: 500;
    padding: 7px 14px; border-radius: var(--r-xs);
    border: 1px solid var(--border-l); background: var(--bg-card);
    color: var(--text-2); cursor: pointer;
    transition: all .12s ease; outline: none;
  }
  .btn:hover { background: var(--bg-hover); border-color: var(--border-xl); color: var(--text); }
  .btn:active { transform: scale(0.97); }
  .btn.accent {
    background: rgba(99,102,241,0.12); border-color: rgba(99,102,241,0.25);
    color: var(--accent);
  }
  .btn.accent:hover {
    background: rgba(99,102,241,0.18); border-color: rgba(99,102,241,0.35);
  }

  /* ─── Cards ────────────────────────────────────────── */
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .card {
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: var(--r); overflow: hidden;
  }
  .card-head {
    padding: 14px 18px; border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
    font-size: 12px; font-weight: 600; color: var(--text-2);
    text-transform: uppercase; letter-spacing: 0.04em;
  }
  .card-head .count { font-weight: 400; color: var(--text-4); text-transform: none; letter-spacing: 0; }

  /* ─── Violations ───────────────────────────────────── */
  .v-row {
    display: flex; align-items: center; gap: 10px;
    padding: 10px 18px; border-bottom: 1px solid var(--border);
    font-size: 13px; transition: background .1s;
  }
  .v-row:last-child { border-bottom: none; }
  .v-row:hover { background: var(--bg-hover); }
  .sev {
    font-size: 10px; font-weight: 600; padding: 2px 7px;
    border-radius: 4px; text-transform: uppercase; letter-spacing: 0.03em;
    flex-shrink: 0;
  }
  .sev.critical { background: var(--red-bg); color: var(--red); }
  .sev.high { background: var(--amber-bg); color: var(--amber); }
  .sev.medium { background: rgba(129,140,248,0.08); color: var(--accent); }
  .v-id { font-size: 12px; color: var(--text-3); min-width: 96px; font-variant-numeric: tabular-nums; }
  .v-msg { flex: 1; color: var(--text-3); font-size: 12px; }
  .v-ct { font-size: 12px; color: var(--text-4); font-variant-numeric: tabular-nums; margin-left: auto; }

  /* ─── Agent Bars ───────────────────────────────────── */
  .ab-list { padding: 14px 18px; }
  .ab-row { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
  .ab-row:last-child { margin-bottom: 0; }
  .ab-name {
    font-size: 12px; color: var(--text-3); min-width: 100px;
    text-align: right; font-variant-numeric: tabular-nums;
  }
  .ab-track { flex: 1; height: 5px; background: var(--border); border-radius: 3px; overflow: hidden; display: flex; }
  .ab-bar { height: 100%; transition: width .5s ease; }
  .ab-bar.g { background: var(--green); }
  .ab-bar.r { background: var(--red); }
  .ab-total { font-size: 11px; color: var(--text-4); min-width: 28px; font-variant-numeric: tabular-nums; }

  /* ─── Audit Trail ──────────────────────────────────── */
  .h-head {
    display: grid; grid-template-columns: 56px 1fr 80px 52px;
    gap: 10px; padding: 10px 18px; font-size: 11px;
    color: var(--text-4); text-transform: uppercase; letter-spacing: 0.04em;
    font-weight: 600; border-bottom: 1px solid var(--border);
  }
  .h-row {
    display: grid; grid-template-columns: 56px 1fr 80px 52px;
    gap: 10px; align-items: center;
    padding: 9px 18px; border-bottom: 1px solid var(--border);
    font-size: 13px; transition: background .1s;
  }
  .h-row:last-child { border-bottom: none; }
  .h-row:hover { background: var(--bg-hover); }
  .badge {
    font-size: 10px; font-weight: 600; padding: 2px 8px;
    border-radius: 4px; text-transform: uppercase; letter-spacing: 0.03em;
    text-align: center; width: fit-content;
  }
  .badge.pass { background: var(--green-bg); color: var(--green); }
  .badge.fail { background: var(--red-bg); color: var(--red); }
  .h-agents { display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--text-2); }
  .h-arrow { color: var(--text-4); }
  .h-time { font-size: 11px; color: var(--text-4); font-variant-numeric: tabular-nums; }
  .h-viol { font-size: 12px; color: var(--text-4); text-align: right; font-variant-numeric: tabular-nums; }

  /* ─── Scrollable ───────────────────────────────────── */
  .scroll { max-height: 380px; overflow-y: auto; }
  .scroll::-webkit-scrollbar { width: 5px; }
  .scroll::-webkit-scrollbar-track { background: transparent; }
  .scroll::-webkit-scrollbar-thumb { background: var(--border-xl); border-radius: 3px; }

  /* ─── Toast ────────────────────────────────────────── */
  .toast-wrap {
    position: fixed; bottom: 20px; right: 20px; z-index: 200;
    display: flex; flex-direction: column; gap: 8px; pointer-events: none;
  }
  .toast {
    pointer-events: auto;
    background: var(--bg-card); border: 1px solid var(--border-l);
    border-radius: var(--r-sm); padding: 10px 16px; font-size: 13px;
    max-width: 340px; color: var(--text-2);
    animation: tin .25s ease, tout .25s ease 2.75s forwards;
    box-shadow: 0 4px 24px rgba(0,0,0,0.4);
  }
  .toast.ok { border-left: 3px solid var(--green); }
  .toast.err { border-left: 3px solid var(--red); }
  @keyframes tin { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }
  @keyframes tout { from{opacity:1} to{opacity:0} }

  .empty { padding: 28px 18px; text-align: center; color: var(--text-4); font-size: 13px; }

  /* ─── Tooltips ───────────────────────────────────── */
  .tip {
    position: relative; cursor: help;
    border-bottom: 1px dotted var(--text-4);
  }
  .tip::after {
    content: attr(data-tip);
    position: absolute; bottom: calc(100% + 8px); left: 50%;
    transform: translateX(-50%); white-space: pre-line;
    background: #1c1c22; color: var(--text-2);
    font-size: 11px; font-weight: 400; line-height: 1.5;
    padding: 8px 12px; border-radius: 8px;
    border: 1px solid var(--border-l);
    box-shadow: 0 8px 24px rgba(0,0,0,0.5);
    pointer-events: none; opacity: 0;
    transition: opacity .15s, transform .15s;
    transform: translateX(-50%) translateY(4px);
    z-index: 300; min-width: 180px; max-width: 300px;
    text-transform: none; letter-spacing: 0; font-family: 'Inter', sans-serif;
  }
  .tip:hover::after {
    opacity: 1; transform: translateX(-50%) translateY(0);
  }
  .tip.tip-right::after { left: 0; transform: translateX(0) translateY(4px); }
  .tip.tip-right:hover::after { transform: translateX(0) translateY(0); }

  /* ─── Terminal ───────────────────────────────────── */
  .term {
    background: #050507; border: 1px solid var(--border);
    border-radius: var(--r); overflow: hidden;
  }
  .term-head {
    padding: 10px 16px; border-bottom: 1px solid var(--border);
    display: flex; align-items: center; gap: 8px;
    font-size: 12px; color: var(--text-3);
  }
  .term-dots { display: flex; gap: 5px; }
  .term-dots span {
    width: 10px; height: 10px; border-radius: 50%;
    background: var(--border-xl);
  }
  .term-dots span:nth-child(1) { background: #ff5f57; }
  .term-dots span:nth-child(2) { background: #febc2e; }
  .term-dots span:nth-child(3) { background: #28c840; }
  .term-body {
    padding: 14px 16px; max-height: 360px; overflow-y: auto;
    font-family: 'SF Mono', 'Cascadia Code', 'Fira Code', Menlo, monospace;
    font-size: 11.5px; line-height: 1.7; white-space: pre; color: #737380;
    scroll-behavior: smooth;
  }
  .term-body::-webkit-scrollbar { width: 5px; }
  .term-body::-webkit-scrollbar-track { background: transparent; }
  .term-body::-webkit-scrollbar-thumb { background: var(--border-xl); border-radius: 3px; }
  .t-pass { color: #4ade80; }
  .t-fail { color: #f87171; }
  .t-warn { color: #fbbf24; }
  .t-dim { color: #3f3f46; }
  .t-key { color: #818cf8; }
  .t-str { color: #a78bfa; }
  .t-num { color: #22d3ee; }
  .t-sev-critical { color: #f87171; font-weight: 600; }
  .t-sev-high { color: #fbbf24; }
  .t-sev-medium { color: #818cf8; }
  .t-sev-low { color: #737380; }
  .t-ts { color: #52525b; }
  .t-agent { color: #e4e4e7; }
  .t-rule { color: #a1a1aa; }

  /* ─── Handoff Detail ─────────────────────────────── */
  .h-row { cursor: pointer; }
  .h-detail {
    display: none; grid-column: 1 / -1;
    padding: 0 18px 14px; border-bottom: 1px solid var(--border);
    animation: slideIn .15s ease;
  }
  .h-detail.open { display: block; }
  @keyframes slideIn { from { opacity: 0; transform: translateY(-4px); } to { opacity: 1; transform: translateY(0); } }
  .h-detail-inner {
    background: #0a0a0d; border: 1px solid var(--border);
    border-radius: var(--r-sm); overflow: hidden;
  }
  .h-detail-tabs {
    display: flex; border-bottom: 1px solid var(--border);
  }
  .h-detail-tab {
    padding: 8px 14px; font-size: 11px; font-weight: 600;
    color: var(--text-4); cursor: pointer; text-transform: uppercase;
    letter-spacing: 0.04em; border-bottom: 2px solid transparent;
    transition: color .1s, border-color .1s;
  }
  .h-detail-tab.active { color: var(--accent); border-bottom-color: var(--accent); }
  .h-detail-tab:hover { color: var(--text-2); }
  .h-detail-pane {
    padding: 12px 14px;
    font-family: 'SF Mono', 'Cascadia Code', 'Fira Code', Menlo, monospace;
    font-size: 11.5px; line-height: 1.6; color: #a1a1aa;
    max-height: 220px; overflow-y: auto; white-space: pre-wrap;
    word-break: break-all;
  }
  .h-detail-pane::-webkit-scrollbar { width: 4px; }
  .h-detail-pane::-webkit-scrollbar-thumb { background: var(--border-xl); border-radius: 2px; }
  .h-meta-row {
    display: flex; gap: 16px; padding: 8px 14px;
    border-bottom: 1px solid var(--border);
    font-size: 11px; color: var(--text-4);
    font-family: 'SF Mono', 'Cascadia Code', Menlo, monospace;
  }
  .h-meta-row span { display: flex; gap: 4px; }
  .h-meta-lbl { color: var(--text-4); }
  .h-meta-val { color: var(--text-2); }

  /* ─── Agent Cards ─────────────────────────────────── */
  .agent-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 12px; }
  .agent-card {
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: var(--r); overflow: hidden; transition: border-color .15s;
  }
  .agent-card:hover { border-color: var(--border-xl); }
  .agent-head {
    padding: 14px 16px; border-bottom: 1px solid var(--border);
    display: flex; align-items: center; gap: 10px;
  }
  .agent-av {
    width: 32px; height: 32px; border-radius: 8px;
    display: grid; place-items: center;
    font-size: 11px; font-weight: 700; color: #fff; flex-shrink: 0;
    box-shadow: inset 0 1px 0 rgba(255,255,255,0.08), 0 1px 4px rgba(0,0,0,0.3);
  }
  .agent-info { flex: 1; min-width: 0; }
  .agent-name { font-size: 13px; font-weight: 600; color: var(--text); }
  .agent-desc { font-size: 11px; color: var(--text-3); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .agent-section {
    padding: 10px 16px; border-bottom: 1px solid var(--border);
  }
  .agent-section:last-child { border-bottom: none; }
  .agent-section-lbl {
    font-size: 10px; font-weight: 600; color: var(--text-4);
    text-transform: uppercase; letter-spacing: 0.04em; margin-bottom: 6px;
  }
  .agent-tags { display: flex; flex-wrap: wrap; gap: 4px; }
  .agent-tag {
    font-size: 10px; font-weight: 500; padding: 2px 7px;
    border-radius: 4px; letter-spacing: 0.02em;
  }
  .agent-tag.skill { background: var(--accent-bg); color: var(--accent); }
  .agent-tag.domain { background: rgba(34,211,238,0.08); color: #22d3ee; }
  .agent-tag.scope { background: var(--green-bg); color: var(--green); }
  .agent-tag.auth {
    font-weight: 600; text-transform: uppercase; letter-spacing: 0.03em;
  }
  .agent-tag.auth-read_only { background: rgba(161,161,170,0.08); color: #a1a1aa; }
  .agent-tag.auth-read_write { background: var(--accent-bg); color: var(--accent); }
  .agent-tag.auth-execute { background: var(--amber-bg); color: var(--amber); }
  .agent-tag.auth-admin { background: var(--red-bg); color: var(--red); }
  .agent-code {
    padding: 10px 14px;
    font-family: 'SF Mono', 'Cascadia Code', Menlo, monospace;
    font-size: 11px; line-height: 1.6; color: #a1a1aa;
    background: #0a0a0d; max-height: 180px; overflow-y: auto;
    white-space: pre; display: none; border-top: 1px solid var(--border);
  }
  .agent-code.open { display: block; }
  .agent-code::-webkit-scrollbar { width: 4px; }
  .agent-code::-webkit-scrollbar-thumb { background: var(--border-xl); border-radius: 2px; }
  .agent-toggle {
    font-size: 11px; color: var(--text-4); cursor: pointer;
    padding: 8px 16px; text-align: center; transition: color .1s;
    border-top: 1px solid var(--border);
  }
  .agent-toggle:hover { color: var(--accent); }

  /* ─── Contract Cards ─────────────────────────────── */
  .ctr-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 12px; }
  .ctr-card {
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: var(--r); overflow: hidden;
  }
  .ctr-head {
    padding: 12px 16px; border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
  }
  .ctr-title { font-size: 13px; font-weight: 600; color: var(--text); }
  .ctr-id { font-size: 11px; color: var(--text-4); font-family: 'SF Mono', Menlo, monospace; }
  .ctr-agents {
    padding: 10px 16px; font-size: 12px; color: var(--text-2);
    display: flex; align-items: center; gap: 6px;
    border-bottom: 1px solid var(--border);
  }
  .ctr-agents .arrow { color: var(--text-4); }
  .ctr-fields { padding: 0; }
  .ctr-field {
    display: grid; grid-template-columns: 1fr auto;
    padding: 8px 16px; border-bottom: 1px solid var(--border);
    font-size: 12px; gap: 8px;
  }
  .ctr-field:last-child { border-bottom: none; }
  .ctr-fname { color: var(--text-2); font-family: 'SF Mono', Menlo, monospace; font-size: 11.5px; }
  .ctr-fmeta { display: flex; gap: 6px; align-items: center; justify-content: flex-end; flex-wrap: wrap; }
  .ctr-tag {
    font-size: 9px; font-weight: 600; padding: 2px 6px;
    border-radius: 3px; text-transform: uppercase; letter-spacing: 0.03em;
  }
  .ctr-tag.type { background: rgba(129,140,248,0.08); color: var(--accent); }
  .ctr-tag.req { background: var(--amber-bg); color: var(--amber); }
  .ctr-tag.pii { background: var(--red-bg); color: var(--red); }
  .ctr-tag.fin { background: rgba(34,211,238,0.08); color: #22d3ee; }
  .ctr-tag.pattern { background: rgba(167,139,250,0.08); color: #a78bfa; font-family: 'SF Mono', Menlo, monospace; font-size: 9px; }
  .ctr-compliance {
    padding: 10px 16px; display: flex; gap: 6px; flex-wrap: wrap;
    border-top: 1px solid var(--border);
  }
  .ctr-scope {
    font-size: 10px; font-weight: 600; padding: 2px 7px;
    border-radius: 4px; background: var(--green-bg); color: var(--green);
    letter-spacing: 0.03em;
  }

  /* ─── Custom Handoff Form ──────────────────────── */
  .form-card {
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: var(--r); overflow: hidden;
  }
  .form-body { padding: 18px; }
  .form-row {
    display: grid; grid-template-columns: 1fr 1fr; gap: 12px;
    margin-bottom: 12px;
  }
  .form-row.full { grid-template-columns: 1fr; }
  .form-group { display: flex; flex-direction: column; gap: 4px; }
  .form-lbl {
    font-size: 11px; font-weight: 600; color: var(--text-3);
    text-transform: uppercase; letter-spacing: 0.04em;
  }
  .form-select, .form-input, .form-textarea {
    font-family: 'SF Mono', 'Cascadia Code', Menlo, monospace;
    font-size: 12px; color: var(--text); background: var(--bg-input);
    border: 1px solid var(--border-l); border-radius: var(--r-xs);
    padding: 8px 10px; outline: none; transition: border-color .12s;
    width: 100%;
  }
  .form-select:focus, .form-input:focus, .form-textarea:focus {
    border-color: rgba(129,140,248,0.4);
  }
  .form-select { cursor: pointer; }
  .form-textarea { min-height: 80px; resize: vertical; line-height: 1.5; }
  .form-actions {
    display: flex; align-items: center; gap: 10px;
    padding-top: 4px;
  }
  .form-result {
    margin-top: 12px; padding: 12px 14px;
    background: #0a0a0d; border: 1px solid var(--border);
    border-radius: var(--r-sm);
    font-family: 'SF Mono', 'Cascadia Code', Menlo, monospace;
    font-size: 11.5px; line-height: 1.6; color: #a1a1aa;
    max-height: 200px; overflow-y: auto; white-space: pre-wrap;
    display: none;
  }
  .form-result.visible { display: block; }

  @media (max-width: 768px) {
    .grid-2 { grid-template-columns: 1fr; }
    .stats-grid { grid-template-columns: repeat(2,1fr); }
    .pl-row { flex-wrap: wrap; justify-content: center; }
    .ctr-grid { grid-template-columns: 1fr; }
  }

  .footer { height: 64px; }
</style>
</head>
<body>

<nav>
  <div class="wrap nav-inner">
    <div class="brand">
      <div class="brand-mark">A</div>
      <span class="brand-name">Failsafe</span>
    </div>
    <div class="nav-meta">
      <span class="live"><span class="live-dot"></span> Monitoring</span>
      <span id="nav-info">4 agents &middot; 3 contracts</span>
    </div>
  </div>
</nav>

<div class="wrap">

  <div class="stats-grid" id="stats">
    <div class="stat-cell">
      <div class="stat-num" id="s-total">&mdash;</div>
      <div class="stat-lbl tip" data-tip="Every data transfer between agents that was validated by the engine">Total Handoffs</div>
    </div>
    <div class="stat-cell">
      <div class="stat-num c-green" id="s-pass">&mdash;</div>
      <div class="stat-lbl tip" data-tip="Handoffs with zero violations — data matched the contract schema, authority was sufficient, and no policy rules fired">Passed</div>
    </div>
    <div class="stat-cell">
      <div class="stat-num c-red" id="s-fail">&mdash;</div>
      <div class="stat-lbl tip" data-tip="Handoffs where at least one CRITICAL or HIGH severity violation was found (schema mismatch, PII leak, authority escalation, etc.)">Failed</div>
    </div>
    <div class="stat-cell">
      <div class="stat-num c-amber" id="s-block">&mdash;</div>
      <div class="stat-lbl tip" data-tip="Failed handoffs that were actively prevented from executing. In enforce mode, any CRITICAL/HIGH violation blocks the handoff.">Blocked</div>
    </div>
  </div>

  <div class="sec">
    <div class="sec-head">
      <span class="sec-title tip tip-right" data-tip="Shows the 4 agents in the financial workflow and the contracts governing each handoff. Edge colors reflect the last validation result: green = pass, red = fail/blocked.">Agent Pipeline</span>
      <span class="sec-sub">Contract-validated handoff chain</span>
    </div>
    <div class="pipeline-card">
      <div class="pl-row">
        <div class="pl-node">
          <div class="pl-avatar n0">CS</div>
          <div class="pl-name">Customer Service</div>
          <div class="pl-role tip" data-tip="Can only read data. Cannot modify records or execute trades.">Read Only</div>
        </div>
        <div class="pl-edge">
          <div class="pl-line idle" id="e0"></div>
          <div class="pl-ctr">CTR-001</div>
        </div>
        <div class="pl-node">
          <div class="pl-avatar n1">RA</div>
          <div class="pl-name">Research</div>
          <div class="pl-role tip" data-tip="Can read and write data. Analyzes markets and generates recommendations.">Read Write</div>
        </div>
        <div class="pl-edge">
          <div class="pl-line idle" id="e1"></div>
          <div class="pl-ctr">CTR-002</div>
        </div>
        <div class="pl-node">
          <div class="pl-avatar n2">TA</div>
          <div class="pl-name">Trading</div>
          <div class="pl-role tip" data-tip="Can execute trades. Highest operational authority — requires contract approval for each action.">Execute</div>
        </div>
        <div class="pl-edge">
          <div class="pl-line idle" id="e2"></div>
          <div class="pl-ctr">CTR-003</div>
        </div>
        <div class="pl-node">
          <div class="pl-avatar n3">CA</div>
          <div class="pl-name">Compliance</div>
          <div class="pl-role tip" data-tip="Full admin access. Reviews all transactions for SOX, SEC, and FINRA regulatory compliance.">Admin</div>
        </div>
      </div>
    </div>
  </div>

  <div class="sec">
    <div class="sec-head">
      <span class="sec-title">Simulate</span>
      <span class="sec-sub">Run validation scenarios</span>
    </div>
    <div class="act-row" style="margin-bottom: 16px;">
      <button class="btn accent tip tip-right" data-tip="Sends a valid portfolio review request from customer_service to research_agent. All fields match the contract schema." onclick="sim('happy')">Valid Handoff</button>
      <button class="btn tip" data-tip="Embeds a Social Security Number in the rationale field. Triggers FIN-PII-002 (SSN pattern detection)." onclick="sim('ssn_leak')">SSN Leak</button>
      <button class="btn tip" data-tip="Sends an $80K trade recommendation without human_approved metadata. Triggers FIN-AUTH-003 ($10K threshold)." onclick="sim('large_tx')">Large Transaction</button>
      <button class="btn tip" data-tip="customer_service tries to trade directly with trading_agent, skipping research. No contract exists for this pair." onclick="sim('authority_escalation')">Authority Escalation</button>
    </div>
    <div class="form-card">
      <div class="card-head"><span class="tip tip-right" data-tip="Build a custom handoff and validate it live against the engine. The payload is validated against the contract schema, authority rules, and finance policy pack in real-time.">Custom Handoff</span><span class="count">Live validation</span></div>
      <div class="form-body">
        <div class="form-row">
          <div class="form-group">
            <span class="form-lbl">From Agent</span>
            <select class="form-select" id="f-from">
              <option value="customer_service">customer_service</option>
              <option value="research_agent" selected>research_agent</option>
              <option value="trading_agent">trading_agent</option>
              <option value="compliance_agent">compliance_agent</option>
            </select>
          </div>
          <div class="form-group">
            <span class="form-lbl">To Agent</span>
            <select class="form-select" id="f-to">
              <option value="customer_service">customer_service</option>
              <option value="research_agent">research_agent</option>
              <option value="trading_agent" selected>trading_agent</option>
              <option value="compliance_agent">compliance_agent</option>
            </select>
          </div>
        </div>
        <div class="form-row full">
          <div class="form-group">
            <span class="form-lbl tip tip-right" data-tip="The data being handed off between agents. Must match the contract's field schema (types, patterns, ranges). Try adding an SSN or changing amount to 80000.">Payload (JSON)</span>
            <textarea class="form-textarea" id="f-payload">{
  "symbol": "AAPL",
  "action": "buy",
  "amount": 5000,
  "rationale": "Portfolio rebalancing"
}</textarea>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <span class="form-lbl tip tip-right" data-tip="The action type for this handoff. Must be in the contract's allowed_actions list. Try 'trade' or 'delete' to trigger violations.">Action (metadata)</span>
            <input class="form-input" id="f-action" value="recommend" placeholder="e.g. recommend, trade, query">
          </div>
          <div class="form-group">
            <span class="form-lbl">Options</span>
            <label style="display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text-3);padding-top:4px;">
              <input type="checkbox" id="f-approval"> <span class="tip tip-right" data-tip="Transactions over $10,000 require human approval (FIN-AUTH-003). Check this to add human_approved=true to metadata.">Human approved</span>
            </label>
          </div>
        </div>
        <div class="form-actions">
          <button class="btn accent" onclick="sendCustom()">Validate Handoff</button>
          <span class="sec-sub" id="f-status"></span>
        </div>
        <div class="form-result" id="f-result"></div>
      </div>
    </div>
  </div>

  <div class="sec">
    <div class="grid-2">
      <div class="card">
        <div class="card-head">
          <span class="tip tip-right" data-tip="Most frequently triggered validation rules across all handoffs. Severity levels: CRITICAL (blocks + alert), HIGH (blocks), MEDIUM (warning only).">Top Violations</span>
          <span class="count" id="viol-ct"></span>
        </div>
        <div class="scroll" id="viol-list"><div class="empty">Loading</div></div>
      </div>
      <div class="card">
        <div class="card-head"><span class="tip tip-right" data-tip="Pass/fail ratio per agent. Green bars = passed validations, red bars = failed. Agents involved in more handoffs appear with wider bars.">Agent Activity</span></div>
        <div class="ab-list" id="ab-list"><div class="empty">Loading</div></div>
      </div>
    </div>
  </div>

  <div class="sec">
    <div class="sec-head">
      <span class="sec-title tip tip-right" data-tip="Every handoff validation result, newest first. Click any row to inspect the payload data and individual violations.">Audit Trail</span>
      <span class="sec-sub" id="h-ct"></span>
    </div>
    <div class="card">
      <div class="h-head">
        <span>Status</span><span>Handoff</span><span>Time</span><span style="text-align:right">Issues</span>
      </div>
      <div class="scroll" id="h-list"><div class="empty">Loading</div></div>
    </div>
  </div>

  <div class="sec">
    <div class="sec-head">
      <span class="sec-title tip tip-right" data-tip="The formal contracts governing each agent-to-agent handoff. Defines required fields, types, regex patterns, authority levels, and compliance scopes.">Contracts</span>
      <span class="sec-sub" id="ctr-ct"></span>
    </div>
    <div class="ctr-grid" id="ctr-list"><div class="empty">Loading</div></div>
  </div>

  <div class="sec">
    <div class="sec-head">
      <span class="sec-title tip tip-right" data-tip="Raw output from the validation engine, formatted like server logs. Shows timestamps, results, agent pairs, contract IDs, sub-millisecond timing, violations, and payload previews.">Validation Log</span>
      <span class="sec-sub">Raw engine output</span>
    </div>
    <div class="term">
      <div class="term-head">
        <div class="term-dots"><span></span><span></span><span></span></div>
        <span>failsafe — validation engine</span>
      </div>
      <div class="term-body" id="term"></div>
    </div>
  </div>

  <div class="footer"></div>
</div>

<div class="toast-wrap" id="toasts"></div>

<script>
const F = url => fetch(url).then(r => r.json());
const $ = id => document.getElementById(id);

const NAMES = {
  customer_service: 'customer_svc',
  research_agent: 'research',
  trading_agent: 'trading',
  compliance_agent: 'compliance',
};
const sn = n => NAMES[n] || n;
const trunc = (s, n) => s.length > n ? s.slice(0, n) + '\u2026' : s;
const esc = s => String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

function renderStats(d) {
  const s = d.summary;
  $('s-total').textContent = s.total_handoffs;
  $('s-pass').textContent = s.passed;
  $('s-fail').textContent = s.failed;
  $('s-block').textContent = s.blocked;
}

function renderViolations(d) {
  const el = $('viol-list');
  const items = (d.violations && d.violations.top_violations) || [];
  $('viol-ct').textContent = items.length ? items.length + ' types' : '';
  if (!items.length) { el.innerHTML = '<div class="empty">No violations</div>'; return; }
  el.innerHTML = items.map(v => {
    const rid = (v.rule || '').split(':')[0].trim();
    const rname = (v.rule || '').split(':').slice(1).join(':').trim();
    const s = rid.match(/^FIN-PII|^FIN-AUTH-00[12]|^FIN-DATA|^FIN-AUDIT-002|^CONTRACT/) ? 'critical'
      : rid.match(/^FIN-|^SCHEMA_00[13]|^AUTH_/) ? 'high' : 'medium';
    return `<div class="v-row">
      <span class="sev ${s}">${s}</span>
      <span class="v-id">${rid}</span>
      <span class="v-msg">${trunc(rname || rid, 44)}</span>
      <span class="v-ct">${v.count}&times;</span>
    </div>`;
  }).join('');
}

function renderAgents(d) {
  const el = $('ab-list');
  const agents = d.agents || {};
  const names = Object.keys(agents);
  if (!names.length) { el.innerHTML = '<div class="empty">No data</div>'; return; }
  const mx = Math.max(...names.map(n => agents[n].total || 1));
  el.innerHTML = names.map(n => {
    const a = agents[n];
    const pw = ((a.passed / mx) * 100).toFixed(1);
    const fw = ((a.failed / mx) * 100).toFixed(1);
    return `<div class="ab-row">
      <span class="ab-name">${sn(n)}</span>
      <div class="ab-track">
        <div class="ab-bar g" style="width:${pw}%"></div>
        <div class="ab-bar r" style="width:${fw}%"></div>
      </div>
      <span class="ab-total">${a.total}</span>
    </div>`;
  }).join('');
}

// detail data store — avoids btoa/atob encoding issues
const _detailData = {};

function renderHandoffs(list) {
  const el = $('h-list');
  $('h-ct').textContent = list.length + ' records';
  if (!list.length) { el.innerHTML = '<div class="empty">No handoffs</div>'; return; }
  el.innerHTML = [...list].reverse().map((h, i) => {
    const r = h.result || 'pass';
    const t = h.timestamp ? new Date(h.timestamp).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'}) : '';
    const allV = [...(h.violations?.schema||[]), ...(h.violations?.policy||[]), ...(h.violations?.authority||[])];
    const dur = h.validation_duration_ms != null ? h.validation_duration_ms.toFixed(3) : '?';

    let payloadHtml = h.payload
      ? esc(JSON.stringify(h.payload, null, 2))
      : '<span style="color:var(--text-4)">No payload snapshot</span>';

    let violHtml = allV.length
      ? allV.map(v => {
          const sc = `t-sev-${v.severity}`;
          let line = `<span class="${sc}">[${v.severity.toUpperCase()}]</span> <span class="t-rule">${esc(v.rule_id)}</span> ${esc(v.message)}`;
          if (v.expected) line += `\n         expected: ${esc(v.expected)}`;
          if (v.actual) line += `  actual: ${esc(v.actual)}`;
          return line;
        }).join('\n')
      : '<span style="color:var(--text-4)">No violations</span>';

    _detailData[i] = { payload: payloadHtml, violations: violHtml };

    return `<div class="h-row" onclick="toggleDetail(${i})">
      <span class="badge ${r}">${r}</span>
      <div class="h-agents">
        <span>${sn(h.consumer)}</span>
        <span class="h-arrow">\u2192</span>
        <span>${sn(h.provider)}</span>
      </div>
      <span class="h-time">${t}</span>
      <span class="h-viol">${h.total_violations}</span>
    </div>
    <div class="h-detail" id="hd-${i}">
      <div class="h-detail-inner">
        <div class="h-meta-row">
          <span><span class="h-meta-lbl">id</span> <span class="h-meta-val">${esc(h.handoff_id)}</span></span>
          <span><span class="h-meta-lbl">contract</span> <span class="h-meta-val">${esc(h.contract_id || 'none')}</span></span>
          <span><span class="h-meta-lbl">duration</span> <span class="h-meta-val">${dur}ms</span></span>
          <span><span class="h-meta-lbl">direction</span> <span class="h-meta-val">${esc(h.direction)}</span></span>
        </div>
        <div class="h-detail-tabs">
          <div class="h-detail-tab active" onclick="event.stopPropagation();switchTab(${i},'payload')">Payload</div>
          <div class="h-detail-tab" onclick="event.stopPropagation();switchTab(${i},'violations')">Violations (${allV.length})</div>
        </div>
        <div class="h-detail-pane" id="hdp-${i}">${payloadHtml}</div>
      </div>
    </div>`;
  }).join('');
}

function toggleDetail(i) {
  const el = $('hd-' + i);
  if (el) el.classList.toggle('open');
}

function switchTab(i, tab) {
  const pane = $('hdp-' + i);
  const d = _detailData[i];
  if (!pane || !d) return;
  pane.innerHTML = d[tab];
  const tabs = pane.closest('.h-detail-inner').querySelectorAll('.h-detail-tab');
  tabs.forEach((t, j) => t.classList.toggle('active', (tab === 'payload' ? j === 0 : j === 1)));
}

function renderContracts(contracts) {
  const el = $('ctr-list');
  const ids = Object.keys(contracts);
  $('ctr-ct').textContent = ids.length + ' contracts';
  if (!ids.length) { el.innerHTML = '<div class="empty">No contracts</div>'; return; }
  el.innerHTML = ids.map(cid => {
    const c = contracts[cid];
    const fields = (c.request_schema || []).map(f => {
      let tags = `<span class="ctr-tag type">${esc(f.type)}</span>`;
      if (f.required) tags += `<span class="ctr-tag req">required</span>`;
      if (f.pii) tags += `<span class="ctr-tag pii">pii</span>`;
      if (f.financial_data) tags += `<span class="ctr-tag fin">financial</span>`;
      if (f.pattern) tags += `<span class="ctr-tag pattern">${esc(f.pattern)}</span>`;
      if (f.enum) tags += `<span class="ctr-tag type">${f.enum.join('|')}</span>`;
      return `<div class="ctr-field"><span class="ctr-fname">${esc(f.name)}</span><div class="ctr-fmeta">${tags}</div></div>`;
    }).join('');
    const scopes = (c.compliance?.scopes || []).map(s => `<span class="ctr-scope">${esc(s)}</span>`).join('');
    return `<div class="ctr-card">
      <div class="ctr-head">
        <span class="ctr-title">${esc(c.name)}</span>
        <span class="ctr-id">${esc(cid)}</span>
      </div>
      <div class="ctr-agents">
        <span>${sn(c.consumer)}</span>
        <span class="arrow">\u2192</span>
        <span>${sn(c.provider)}</span>
        <span style="margin-left:auto;font-size:11px;color:var(--text-4)">${esc(c.authority?.required_level || '')}</span>
      </div>
      <div class="ctr-fields">${fields}</div>
      ${scopes ? `<div class="ctr-compliance">${scopes}</div>` : ''}
    </div>`;
  }).join('');
}

function renderTerminal(list) {
  const el = $('term');
  const lines = [];
  lines.push(`<span class="t-dim">failsafe v1.0.0 — validation engine started</span>`);
  lines.push(`<span class="t-dim">policy_packs: [FinancePolicyPack]  rules: 10  mode: enforce</span>`);
  lines.push(`<span class="t-dim">${'─'.repeat(72)}</span>`);
  lines.push('');

  for (const h of list) {
    const ts = h.timestamp ? new Date(h.timestamp).toISOString().slice(11, 23) : '??:??:??.???';
    const rc = h.result === 'pass' ? 't-pass' : h.result === 'fail' ? 't-fail' : 't-warn';
    const res = h.result.toUpperCase().padEnd(4);
    const dur = h.validation_duration_ms != null ? h.validation_duration_ms.toFixed(3).padStart(6) + 'ms' : '  ?.???ms';
    const ctr = (h.contract_id || 'NO-CTR').padEnd(7);
    const blocked = h.blocked ? ' <span class="t-fail">BLOCKED</span>' : '';

    lines.push(`<span class="t-ts">[${ts}]</span> <span class="${rc}">${res}</span> <span class="t-agent">${esc(h.consumer)}</span> <span class="t-dim">\u2192</span> <span class="t-agent">${esc(h.provider)}</span>  <span class="t-dim">${ctr}  ${dur}</span>${blocked}`);

    const allV = [...(h.violations?.schema||[]), ...(h.violations?.policy||[]), ...(h.violations?.authority||[])];
    allV.forEach((v, vi) => {
      const last = vi === allV.length - 1;
      const branch = last ? '\u2514\u2500' : '\u251c\u2500';
      const sc = `t-sev-${v.severity}`;
      lines.push(`  <span class="t-dim">${branch}</span> <span class="${sc}">[${v.severity.toUpperCase()}]</span> <span class="t-rule">${esc(v.rule_id)}</span> <span class="t-dim">${esc(v.message)}</span>`);
    });

    if (h.payload) {
      const keys = Object.keys(h.payload);
      const preview = keys.slice(0, 4).map(k => {
        const val = h.payload[k];
        const sv = typeof val === 'string' ? `<span class="t-str">"${esc(trunc(val, 24))}"</span>`
          : typeof val === 'number' ? `<span class="t-num">${val}</span>`
          : `${esc(JSON.stringify(val))}`;
        return `<span class="t-key">${esc(k)}</span>=` + sv;
      }).join(' ');
      const more = keys.length > 4 ? ` <span class="t-dim">+${keys.length - 4} more</span>` : '';
      lines.push(`  <span class="t-dim">\u2502</span> ${preview}${more}`);
    }

    lines.push('');
  }

  lines.push(`<span class="t-dim">${'─'.repeat(72)}</span>`);
  const passed = list.filter(h => h.result === 'pass').length;
  const failed = list.filter(h => h.result !== 'pass').length;
  lines.push(`<span class="t-dim">summary:</span> <span class="t-pass">${passed} passed</span> <span class="t-fail">${failed} failed</span> <span class="t-dim">${list.length} total</span>`);

  el.innerHTML = lines.join('\n');
  el.scrollTop = el.scrollHeight;
}

function updateEdges(list) {
  const m = {'customer_service:research_agent':'e0','research_agent:trading_agent':'e1','trading_agent:compliance_agent':'e2'};
  Object.values(m).forEach(id => { const e = $(id); if(e) e.className = 'pl-line idle'; });
  for (const h of list) {
    const k = h.consumer + ':' + h.provider;
    const id = m[k]; if (!id) continue;
    const e = $(id); if (!e) continue;
    e.className = 'pl-line ' + (h.blocked ? 'err' : h.result === 'pass' ? 'ok' : 'err');
  }
}

function toast(msg, ok) {
  const t = document.createElement('div');
  t.className = 'toast ' + (ok ? 'ok' : 'err');
  t.textContent = msg;
  $('toasts').appendChild(t);
  setTimeout(() => t.remove(), 3000);
}

async function sendCustom() {
  const from = $('f-from').value;
  const to = $('f-to').value;
  const action = $('f-action').value;
  const approved = $('f-approval').checked;
  const status = $('f-status');
  const resultEl = $('f-result');

  let payload;
  try {
    payload = JSON.parse($('f-payload').value);
  } catch(e) {
    status.textContent = 'Invalid JSON';
    status.style.color = 'var(--red)';
    return;
  }

  status.textContent = 'Validating...';
  status.style.color = 'var(--text-3)';

  try {
    const body = { from_agent: from, to_agent: to, data: payload, metadata: {} };
    if (action) body.metadata.action = action;
    if (approved) body.metadata.human_approved = true;
    body.metadata.request_id = 'CUSTOM-' + Date.now();
    body.metadata.timestamp = new Date().toISOString();
    body.metadata.initiator = 'dashboard';

    const d = await fetch('/api/validate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    }).then(r => r.json());

    if (d.error) {
      status.textContent = 'Error: ' + d.error;
      status.style.color = 'var(--red)';
      return;
    }

    const rc = d.result === 'pass' ? 'var(--green)' : 'var(--red)';
    status.innerHTML = `<span style="color:${rc}">${d.result.toUpperCase()}</span> \u2014 ${d.total_violations} violations, ${(d.validation_duration_ms||0).toFixed(3)}ms`;

    resultEl.innerHTML = esc(JSON.stringify(d, null, 2));
    resultEl.classList.add('visible');

    toast(`${from} \u2192 ${to}: ${d.result.toUpperCase()} (${d.total_violations} violations)`, d.result === 'pass');
    await load();
  } catch(e) {
    status.textContent = 'Error: ' + e.message;
    status.style.color = 'var(--red)';
  }
}

async function sim(scenario) {
  try {
    const d = await fetch('/api/simulate/' + scenario, {method:'POST'}).then(r=>r.json());
    if (d.error) { toast('Error: ' + d.error, false); return; }
    const lbl = {happy:'Valid handoff',ssn_leak:'SSN leak',large_tx:'Large transaction',authority_escalation:'Authority escalation'}[scenario] || scenario;
    toast(lbl + (d.result === 'pass' ? ': Passed' : ': ' + (d.blocked ? 'Blocked' : 'Failed')) + ' \u2014 ' + d.total_violations + ' violations', d.result === 'pass');
    await load();
  } catch(e) { toast('Error: ' + e.message, false); }
}

async function load() {
  const [summary, handoffs, contracts] = await Promise.all([F('/api/summary'), F('/api/handoffs'), F('/api/contracts')]);
  renderStats(summary);
  renderViolations(summary);
  renderAgents(summary);
  renderHandoffs(handoffs);
  renderContracts(contracts);
  renderTerminal(handoffs);
  updateEdges(handoffs);
}

load();
</script>
</body>
</html>
